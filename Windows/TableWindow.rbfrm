#tag WindowBegin Window TableWindow   BackColor       =   16777215   Backdrop        =   ""   CloseButton     =   True   Composite       =   True   Frame           =   1   FullScreen      =   False   HasBackColor    =   False   Height          =   506   ImplicitInstance=   True   LiveResize      =   True   MacProcID       =   0   MaxHeight       =   32000   MaximizeButton  =   False   MaxWidth        =   32000   MenuBar         =   ""   MenuBarVisible  =   True   MinHeight       =   64   MinimizeButton  =   True   MinWidth        =   64   Placement       =   2   Resizeable      =   True   Title           =   "Table Editor"   Visible         =   True   Width           =   569   Begin Label TableField1      AutoDeactivate  =   True      Bold            =   True      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   True      LockRight       =   ""      LockTop         =   True      Multiline       =   ""      Scope           =   0      Selectable      =   False      TabIndex        =   0      TabPanelIndex   =   0      TabStop         =   True      Text            =   "Table Name:"      TextAlign       =   0      TextColor       =   0      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   14      Transparent     =   True      Underline       =   ""      Visible         =   True      Width           =   89   End   Begin TextField TableNameField      AcceptTabs      =   ""      Alignment       =   0      AutoDeactivate  =   True      AutomaticallyCheckSpelling=   False      BackColor       =   16777215      Bold            =   ""      Border          =   True      CueText         =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Format          =   ""      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   121      LimitText       =   0      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   True      Mask            =   ""      Password        =   ""      ReadOnly        =   ""      Scope           =   0      TabIndex        =   1      TabPanelIndex   =   0      TabStop         =   True      Text            =   ""      TextColor       =   0      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   12      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   428   End   Begin Separator Separator1      AutoDeactivate  =   True      Enabled         =   True      Height          =   4      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   20      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   13      TabPanelIndex   =   0      TabStop         =   True      Top             =   450      Visible         =   True      Width           =   529   End   Begin BetterPushButton SaveButton      AutoDeactivate  =   True      Bold            =   ""      ButtonStyle     =   0      Cancel          =   ""      Caption         =   "Add Table"      Default         =   True      Enabled         =   False      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   449      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   15      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   466      Underline       =   ""      Visible         =   True      Width           =   100   End   Begin BetterPushButton CancelButton      AutoDeactivate  =   True      Bold            =   ""      ButtonStyle     =   0      Cancel          =   True      Caption         =   "Cancel"      Default         =   False      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   357      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   14      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   466      Underline       =   ""      Visible         =   True      Width           =   80   End   Begin Separator Separator2      AutoDeactivate  =   True      Enabled         =   True      Height          =   4      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   20      LockBottom      =   False      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   True      Scope           =   0      TabIndex        =   2      TabPanelIndex   =   0      TabStop         =   True      Top             =   46      Visible         =   True      Width           =   529   End   Begin Listbox TableListbox      AutoDeactivate  =   True      AutoHideScrollbars=   True      Bold            =   ""      Border          =   True      ColumnCount     =   5      ColumnsResizable=   True      ColumnWidths    =   0,180,70,      DataField       =   ""      DataSource      =   ""      DefaultRowHeight=   20      Enabled         =   True      EnableDrag      =   ""      EnableDragReorder=   ""      GridLinesHorizontal=   0      GridLinesVertical=   0      HasHeading      =   True      HeadingIndex    =   -1      Height          =   281      HelpTag         =   ""      Hierarchical    =   ""      Index           =   -2147483648      InitialParent   =   ""      InitialValue    =   "Original	Name	Type	Default	 	 "      Italic          =   ""      Left            =   20      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   True      RequiresSelection=   ""      Scope           =   0      ScrollbarHorizontal=   ""      ScrollBarVertical=   True      SelectionType   =   0      TabIndex        =   3      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   62      Underline       =   ""      UseFocusRing    =   False      Visible         =   True      Width           =   529      _ScrollOffset   =   0      _ScrollWidth    =   -1   End   Begin TextField FieldName      AcceptTabs      =   ""      Alignment       =   0      AutoDeactivate  =   True      AutomaticallyCheckSpelling=   False      BackColor       =   16777215      Bold            =   ""      Border          =   True      CueText         =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Format          =   ""      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   121      LimitText       =   0      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   ""      Mask            =   ""      Password        =   ""      ReadOnly        =   ""      Scope           =   0      TabIndex        =   5      TabPanelIndex   =   0      TabStop         =   True      Text            =   ""      TextColor       =   0      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   355      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   248   End   Begin Label TableField11      AutoDeactivate  =   True      Bold            =   True      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      Selectable      =   False      TabIndex        =   4      TabPanelIndex   =   0      TabStop         =   True      Text            =   "Field Name:"      TextAlign       =   0      TextColor       =   0      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   357      Transparent     =   True      Underline       =   ""      Visible         =   True      Width           =   89   End   Begin ComboBox ComboBox1      AutoComplete    =   False      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialValue    =   "TEXT\rINTEGER\rREAL\rBLOB\rCURRENCY\rBOOLEAN\rDATE\rTIME\rTIMESTAMP\rDOUBLE\rFLOAT\rSMALLINT\rVARCHAR\rBINARY"      Italic          =   ""      Left            =   381      ListIndex       =   -1      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   6      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   355      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   168   End   Begin Label TableField111      AutoDeactivate  =   True      Bold            =   True      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   ""      LockTop         =   ""      Multiline       =   ""      Scope           =   0      Selectable      =   False      TabIndex        =   7      TabPanelIndex   =   0      TabStop         =   True      Text            =   "Default Value:"      TextAlign       =   0      TextColor       =   0      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   387      Transparent     =   True      Underline       =   ""      Visible         =   True      Width           =   89   End   Begin TextField FieldDefault      AcceptTabs      =   ""      Alignment       =   0      AutoDeactivate  =   True      AutomaticallyCheckSpelling=   False      BackColor       =   16777215      Bold            =   ""      Border          =   True      CueText         =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Format          =   ""      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   121      LimitText       =   0      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   ""      Mask            =   ""      Password        =   ""      ReadOnly        =   ""      Scope           =   0      TabIndex        =   8      TabPanelIndex   =   0      TabStop         =   True      Text            =   ""      TextColor       =   0      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   385      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   248   End   Begin ComboBox ComboBox2      AutoComplete    =   False      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialValue    =   "PRIMARY KEY\rPRIMARY KEY AUTOINCREMENT\rUNIQUE (single)\rUNIQUE (multi)\rNOT NULL"      Italic          =   ""      Left            =   381      ListIndex       =   -1      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   9      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   386      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   168   End   Begin BetterPushButton AddFieldButton      AutoDeactivate  =   True      Bold            =   ""      ButtonStyle     =   0      Cancel          =   False      Caption         =   "Add Field"      Default         =   False      Enabled         =   True      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   449      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   12      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   418      Underline       =   ""      Visible         =   True      Width           =   100   End   Begin BetterPushButton DropFieldButton      AutoDeactivate  =   True      Bold            =   ""      ButtonStyle     =   0      Cancel          =   False      Caption         =   "Drop Field"      Default         =   False      Enabled         =   False      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   225      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   10      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   418      Underline       =   ""      Visible         =   True      Width           =   100   End   Begin BetterPushButton ChangeFieldButton      AutoDeactivate  =   True      Bold            =   ""      ButtonStyle     =   0      Cancel          =   False      Caption         =   "Change Field"      Default         =   False      Enabled         =   False      Height          =   20      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   337      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   ""      LockRight       =   True      LockTop         =   ""      Scope           =   0      TabIndex        =   11      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "SmallSystem"      TextSize        =   0      TextUnit        =   0      Top             =   418      Underline       =   ""      Visible         =   True      Width           =   100   EndEnd#tag EndWindow#tag WindowCode	#tag Method, Flags = &h21		Private Function AlterTable() As Boolean		  Dim sql As String		  		  ' ALTER TABLE can mess the mvcc or restore in 2009.01 so disable it		  'if (mtable <> TableNameField.Text) then		  'sql =  "ALTER TABLE '" + mtable + "'" + " RENAME TO '" + TableNameField.Text + "'"		  'if (SQLExecute(sql) = false) then return false		  'end if		  		  Dim i, count As Integer		  count = TableListbox.ListCount - 1		  for i=0 to count		    if (TableListbox.Cell(i, 0) = "1") then		      sql =  "ALTER TABLE '" + TableNameField.Text + "'" + " ADD COLUMN " + TableListbox.Cell(i, 1) + " " + TableListbox.Cell(i, 2) + " " + TableListbox.Cell(i, 4)		      if (TableListbox.Cell(i, 3).Len > 0) then sql = sql + " DEFAULT " + TableListbox.Cell(i, 3)		      sql = sql + ";"		      if (SQLExecute(sql) = false) then return false		      TableListbox.Cell(i, 0) = "0"		    end if		  next		  		  return true		End Function	#tag EndMethod	#tag Method, Flags = &h0		Sub Constructor(db As CubeSQLServer, tableName As String, parentWindow as Window)		  Super.Window()		  mdb = db		  mtable = tableName		  isAlter = (mtable.len > 0)		  TableListbox.EnableDragReorder = (not isAlter)		  if isAlter then		    SaveButton.Caption = "Alter Table"		    TableNameField.ReadOnly = true		    DoSetUpFields		  end if		  		  me.ShowModal		End Sub	#tag EndMethod	#tag Method, Flags = &h21		Private Function CreateTable() As Boolean		  dim tname As String = TableNameField.Text		  if (tname.InStr(" ") <> 0) then tname = "[" + tname + "]"		  dim sql As String = "CREATE TABLE "+ tname + " ("		  		  Dim i, count As Integer = TableListbox.ListCount-1		  Dim fields, uniqueFields, constraint As String		  Dim isMulti As Boolean = false		  		  for i=0 to count		    // name		    fields = fields + TableListbox.Cell(i, 1)		    		    // type		    if (TableListbox.Cell(i, 2).len > 0) then fields = fields + " " + TableListbox.Cell(i, 2)		    		    // constraints		    if (TableListbox.Cell(i, 4).len > 0) then		      constraint = TableListbox.Cell(i, 4).Uppercase		      if (constraint = "UNIQUE (MULTI)") then		        isMulti = true		      elseif (constraint = "UNIQUE (SINGLE)") then		        fields = fields + " UNIQUE"		      else		        fields = fields + " " + constraint		      end if		    end if		    		    // default		    if (TableListbox.Cell(i, 3).len > 0) then fields = fields + " DEFAULT " + TableListbox.Cell(i, 3)		    		    // separator		    if (i<>count) then fields = fields + ","		  next		  		  if (isMulti) then		    uniqueFields = " UNIQUE ("		    for i=0 to count		      // name		      constraint = TableListbox.Cell(i, 4).Uppercase		      if (constraint = "UNIQUE (MULTI)") then		        uniqueFields = uniqueFields + TableListbox.Cell(i, 1) + ","		      end if		    next		    // remove latest comma and add a closure		    uniqueFields = uniqueFields.left(uniqueFields.len-1) + ")"		  end if		  		  sql = sql + fields + uniqueFields + ");"		  if (SQLExecute(sql) = false) then return false		  return true		End Function	#tag EndMethod	#tag Method, Flags = &h21		Private Sub DoSetUpFields()		  TableNameField.Text = mtable		  		  dim rs as RecordSet = mdb.SQLSelect("pragma table_info(" + mtable+ ")")		  if (rs = nil) then return		  Dim row As Integer		  while not rs.EOF		    TableListbox.AddRow "0"		    row = TableListbox.LastIndex		    TableListbox.Cell(row, 1) = rs.Field("name").StringValue		    TableListbox.Cell(row, 2) = rs.Field("type").StringValue		    TableListbox.Cell(row, 3) = rs.Field("dflt_value").StringValue		    if (rs.Field("pk").StringValue <> "0") then TableListbox.Cell(row, 4) = "Primary Key"		    rs.MoveNext		  wend		  rs = nil		  		End Sub	#tag EndMethod	#tag Method, Flags = &h21		Private Function SanityCheck() As Boolean		  if (TableNameField.Text.Len = 0) then		    MsgBox "Table name cannot be empty!"		    return false		  end if		  		  if (TableListbox.ListCount = 0) then		    MsgBox "There are no fields to add to this table!"		    return false		  end if		  		  return true		End Function	#tag EndMethod	#tag Method, Flags = &h21		Private Function SanityCheckField() As Boolean		  if (FieldName.text.Len = 0) then		    MsgBox "Field name cannot be empty."		    return false		  end if		  		  if (not isAlter) then return true		  		  Dim s As String = FieldDefault.Text.Uppercase		  		  if (s = "CURRENT_TIME") or (s = "CURRENT_DATE") or (s = "CURRENT_TIMESTAMP")  then		    MsgBox "The column may not have a default value of CURRENT_TIME, CURRENT_DATE or CURRENT_TIMESTAMP in an ALTER TABLE command."		    return False		  end if		  		  s = ComboBox2.Text.Uppercase		  if (s.InStr("PRIMARY KEY") <> 0) or (s.InStr("UNIQUE") <> 0) then		    MsgBox "The column may not have a PRIMARY KEY or UNIQUE constraint in an ALTER TABLE command."		    return False		  end if		  		  return true		End Function	#tag EndMethod	#tag Method, Flags = &h21		Private Function SQLExecute(sql As String) As Boolean		  'MsgBox sql		  'return true		  		  mdb.SQLExecute(sql)		  if (mdb.Error = false) then 		    mChanged = true		    return true		  end if		  		  MsgBox mdb.ErrorMessage + EndOfLine + "Error code: " + Str(mdb.ErrorCode)		  return false		End Function	#tag EndMethod	#tag Property, Flags = &h21		Private isAlter As Boolean	#tag EndProperty	#tag Property, Flags = &h21		Private mChanged As Boolean = false	#tag EndProperty	#tag Property, Flags = &h21		Private mdb As CubeSQLServer	#tag EndProperty	#tag Property, Flags = &h21		Private mtable As String	#tag EndProperty#tag EndWindowCode#tag Events TableNameField	#tag Event		Sub TextChange()		  SaveButton.Enabled = (me.text.Len > 0)		End Sub	#tag EndEvent#tag EndEvents#tag Events SaveButton	#tag Event		Sub Action()		  if (SanityCheck = false) then return		  		  Dim b As Boolean		  if (isAlter) then		    b = AlterTable		  else		    b = CreateTable		  end if		  if (b = false) then return		  		  // ALTER TABLE cannot be rolledback		  if (mChanged) then mdb.Commit		  		  me.Window.Close		End Sub	#tag EndEvent#tag EndEvents#tag Events CancelButton	#tag Event		Sub Action()		  // ALTER TABLE cannot be rolledback		  if (mChanged) then mdb.Commit		  me.Window.Close		End Sub	#tag EndEvent#tag EndEvents#tag Events TableListbox	#tag Event		Function CellBackgroundPaint(g As Graphics, row As Integer, column As Integer) As Boolean		  if row mod 2 = 0 then		    g.ForeColor = RGB(237, 243, 254)//&cEEEEEE //RGB(237, 243, 254)		    g.FillRect 0, 0, g.Width, g.Height		  end if		End Function	#tag EndEvent	#tag Event		Sub Open()		  #If TargetLinux		    me.TextSize = 10		  #endif		  		End Sub	#tag EndEvent	#tag Event		Sub Change()		  DropFieldButton.Enabled = (not isAlter) and (me.ListIndex <> -1)		  ChangeFieldButton.Enabled = (not isAlter) and (me.ListIndex <> -1)		  		  if (me.ListIndex = -1) then		    FieldName.Text = ""		    ComboBox1.Text = ""		    FieldDefault.Text = ""		    ComboBox2.Text = ""		    return		  end if		  		  if (TableListbox.Cell(TableListbox.ListIndex, 0) = "1") then		    FieldName.Text = TableListbox.Cell(TableListbox.ListIndex, 1)		    ComboBox1.Text = TableListbox.Cell(TableListbox.ListIndex, 2) 		    FieldDefault.Text = TableListbox.Cell(TableListbox.ListIndex, 3)		    ComboBox2.Text = TableListbox.Cell(TableListbox.ListIndex, 4)		    DropFieldButton.Enabled = true		    ChangeFieldButton.Enabled = true		  end if		End Sub	#tag EndEvent#tag EndEvents#tag Events ComboBox1	#tag Event		Sub Open()		  #If TargetLinux		    me.Height = me.Height + 4		    me.TextSize = 10		  #endif		End Sub	#tag EndEvent#tag EndEvents#tag Events ComboBox2	#tag Event		Sub Open()		  #If TargetLinux		    me.Height = me.Height + 4		    me.TextSize = 10		  #endif		End Sub	#tag EndEvent#tag EndEvents#tag Events AddFieldButton	#tag Event		Sub Action()		  if (SanityCheckField = false) then return		  		  TableListbox.AddRow ("1")		  TableListbox.Cell(TableListbox.LastIndex, 1) = FieldName.Text		  TableListbox.Cell(TableListbox.LastIndex, 2) = ComboBox1.Text		  TableListbox.Cell(TableListbox.LastIndex, 3) = FieldDefault.Text		  TableListbox.Cell(TableListbox.LastIndex, 4) = ComboBox2.Text		  TableListbox.ListIndex = -1		End Sub	#tag EndEvent#tag EndEvents#tag Events DropFieldButton	#tag Event		Sub Action()		  TableListbox.RemoveRow(TableListbox.ListIndex)		  TableListbox.ListIndex = -1		End Sub	#tag EndEvent#tag EndEvents#tag Events ChangeFieldButton	#tag Event		Sub Action()		  if (FieldName.text.Len = 0) then		    Beep		    return		  end if		  		  TableListbox.Cell(TableListbox.ListIndex, 1) = FieldName.Text		  TableListbox.Cell(TableListbox.ListIndex, 2) = ComboBox1.Text		  TableListbox.Cell(TableListbox.ListIndex, 3) = FieldDefault.Text		  TableListbox.Cell(TableListbox.ListIndex, 4) = ComboBox2.Text		  		End Sub	#tag EndEvent#tag EndEvents